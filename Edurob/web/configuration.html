<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<script>
const saveBtn = document.getElementById('saveBtn');

document.querySelector("form").addEventListener("submit", (e) => {
    saveBtn.classList.add("button-saving");
    saveBtn.innerText = "Saving...";
});
</script>
<body>
    <div class="layout-col">
        <h1>Configuration</h1>
        <form action="/configuration" method="get">
            <div class="layout-col">
            <div class="box">
                <table><tbody></tbody>
                <tr><td><label for="radabstand">Radabstand [m]:</label></td><td><input type="number" id="radabstand" name="radabstand" min="0" step="0.0001" placeholder="Radabstand in meters" required></td></tr>
                
                <tr><td><label for="axenabstand">Axenabstand [m]:</label></td><td><input type="number" id="axenabstand" name="axenabstand" min="0" step="0.0001" placeholder="Axenabstand in meters" required></td></tr>
                
                <tr><td><label for="radradius">Radradius [m]:</label></td><td><input type="number" id="radradius" name="radradius" min="0" step="0.0001" placeholder="Radradius in meters" required></td></tr>
                
                <tr><td><label for="encoderaufloesung">Encoderauflösung [Imp/U] (integer):</label></td><td><input type="number" id="encoderaufloesung" name="encoderaufloesung" min="1" max="65535" step="1" placeholder="Encoderauflösung (integer)" value="28" required></td></tr>
                
                <tr><td><label for="uebersetzung">Übersetzung [−] (integer):</label></td><td><input type="number" id="uebersetzung" name="uebersetzung" min="1" max="65535" step="1" placeholder="Übersetzung (integer)" value="100" required></td></tr>
                
                <tr><td><label for="kinematicOption">Kinematic Option:</label></td><td>
                <select id="kinematicOption" name="kinematicOption" required>
                    <option value="Mecanum">Mecanum</option>
                    <option value="Omni4">Omni4</option>
                    <option value="Omni3">Omni3</option>
                    <option value="Differential">Differential</option>
                </select></td></tr>
                </tbody>
                </table>
            </div>
            <button id="saveBtn" class="link" type="submit">Save</button>
            </div>
        </form>
        <button class="link" onclick="window.location.href='/'">Hauptmenü</button>
    </div>
<script>
  // Restore inputs AND selects from URL
  const urlParams = new URLSearchParams(window.location.search);
  document.querySelectorAll('input[name], select[name]').forEach(el => {
    if (urlParams.has(el.name)) el.value = urlParams.get(el.name);
  });

  window.addEventListener('load', () => {
    const select = document.getElementById('kinematicOption');
    const es = new EventSource('/sse?type=configuration');

    es.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);

        // Inputs
        radabstand.value = data.radabstand;
        axenabstand.value = data.axenabstand;
        radradius.value = data.radradius;
        encoderaufloesung.value = data.encoderaufloesung;
        uebersetzung.value = data.uebersetzung;

        // Safe select set
        const desired = (data.kinematik ?? '').toString().trim();
        if (desired) {
          const match = Array.from(select.options).find(o => o.value === desired)
                    || Array.from(select.options).find(o => o.value.toLowerCase() === desired.toLowerCase());
          if (match) select.value = match.value;
        }

        // Small delay to beat autofill race conditions
        setTimeout(() => {
          if (desired) {
            const match = Array.from(select.options).find(o => o.value === desired);
            if (match) select.value = match.value;
          }
        }, 0);
      } catch (e) {
        console.error('SSE data error:', e);
      } finally {
        es.close();
      }
    };
  });
</script>
</body>
</html>
